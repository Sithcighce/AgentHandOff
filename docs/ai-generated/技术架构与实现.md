3. 技术架构与实现
版本: v7.0.0 (最终蓝图)
状态: 定稿

3.1 系统架构
本系统遵循本地优先和标准 MCP 协议。核心是一个通过 stdio 与宿主环境 (IDE/Agent) 通信的 Python 子进程。

┌───────────────────────────────────────────┐
│              IDE / Editor                 │
│  ┌────────────┐      ┌──────────────────┐ │
│  │  AI Agent  ├──────┤   项目代码仓库   │ │
│  └─────┬──────┘      └──────────────────┘ │
│        └─────────┐  启动子进程  ┌────────┘ │
│                  ▼            ▼           │
│  ┌───────────────────────────────────────┐  │
│  │    Agent-Handoff MCP Server (子进程)  │  │
│  │ <── JSON-RPC over stdio (stdin/stdout) ──> │
│  └───────────────────────────────────────┘  │
└───────────────────────────────────────────┘

3.2 技术选型
核心语言: Python 3.10+

理由: 官方 MCP SDK 支持，强大的 AI/文本处理生态，目标用户熟悉。

CLI 框架: Click

理由: 社区成熟，API 优雅，易于使用。

配置文件格式: YAML

理由: 对人类友好，支持注释，比 JSON 更具可读性。

核心依赖:

mcp-sdk-python: 官方 MCP SDK。

click: 用于构建 init 命令。

PyYAML: 用于解析 .agent-handoff/config.yaml。

3.3 项目仓库结构
agent-handoff/
├── src/
│   └── agent_handoff/
│       ├── __init__.py
│       ├── server.py      # MCP 服务器实现
│       ├── cli.py         # init 命令实现
│       ├── state.py       # 内存状态机管理
│       └── tools/
│           ├── __init__.py
│           ├── workflow_tools.py
│           └── utility_tools.py
├── tests/                 # 测试代码
├── docs/                  # 项目自身的文档
├── pyproject.toml         # 项目配置与依赖
└── README.md

3.4 开发环境
代码格式化: Black + isort

类型检查: MyPy

测试框架: Pytest

3.5 关键实现细节
会话持久化
机制: 采用 Agent 主动写入的策略。服务器本身不自动持久化会话。

流程: end_job 工具会明确指示 Agent 调用 write_file 工具，将本次任务的总结写入 .agent-handoff/history/ 目录下的一个历史文件中。

错误处理
策略: 对 Agent 的所有无效操作，返回明确、结构化的错误信息。

实现: 对于工作流违规 (WORKFLOW_VIOLATION) 或无效路径 (INVALID_PATH) 等情况，服务器会返回一个包含 code, message, suggestion 的 error 对象，以引导 Agent 进行修正。

日志
策略: MVP 阶段，所有服务器日志和错误信息将直接输出到 stderr。

实现: IDE 可以捕获子进程的 stderr 输出，方便开发者进行调试。后续版本可增加日志文件记录。